<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
    <link rel="apple-touch-icon" href="assets/srb2.png">
    <meta name="apple-mobile-web-app-title" content="SRB2">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-2048-2732.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-2732-2048.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-1668-2388.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-2388-1668.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-1668-2224.png" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-2224-1668.png" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-1536-2048.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-2048-1536.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-1242-2688.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-2688-1242.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-1125-2436.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-2436-1125.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-828-1792.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-1792-828.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-1242-2208.png" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-2208-1242.png" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-750-1334.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-1334-750.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-640-1136.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-1136-640.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.3.0/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.10.1/Sortable.min.js"></script>
    <title>Sonic Robo Blast 2</title>
    <style>
      html, body {
        height: 100%;
      }

      body {
        font-family: 'Segoe UI', sans-serif;
        margin: 0;
        padding: none;
        background-color: #000;
        background-image: 
          linear-gradient(90deg, rgba(0,0,0,0.25) 0%, rgba(0,0,0,0.80) 10%, rgba(0,0,0,0.80) 90%, rgba(0,0,0,0.25) 100%),
          url(assets/background.jpg);
        background-size: cover;
        background-attachment: fixed;
        background-position: center;
        color: #ffffff;
      }

      body.startedMainLoop {
        background-image: none;
      }

      body.startedMainLoop #content {
        display: none;
      }

      #content {
        width: 100%;
        height: 100%;
        overflow-y: auto;
        text-align: center;
        display: grid;
      }

      #status-cont {
        display: inline-block;
        font-weight: bold;
        text-align: center;
        margin: auto 10%;
      }

      @media (min-width: 320px) {
        #logo {
          width: 120%;
          height: auto;
          margin: 0 -10%;
        }

        #systemArguments, #userArguments {
          width: 120%;
          margin: 0 -10%;
        }
      }

      @media (min-width: 481px) {
        #logo {
          width: 90%;
          height: auto;
        }

        #systemArguments, #userArguments {
          width: 90%;
        }
      }

      @media (min-width: 641px) {
        #logo {
          width: 60%;
          height: auto;
        }

        #systemArguments, #userArguments {
          width: 60%;
        }
      }

      @media (min-width: 1281px) {
        #logo {
          width: 40%;
          height: auto;
        }

        #systemArguments, #userArguments {
          width: 40%;
        }
      }

      #progress {
        height: 20px;
        width: 256px;
      }

      #startbtn {
        width: 160px;
        height: 48px;
        background-color: yellow;
        color: black;
        background-image: linear-gradient(yellow, orange);
        border: 0.1em orange solid;
        font-weight: bolder;
        font-size: 1.1em;
        cursor: pointer;
      }

      #canvas, #keyCapture {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
      }

      #keyCapture {
        opacity: 0;
        background-color: rgba(0,0,0,0);
        border: 0;
        color: rgba(0,0,0,0);
        z-index: -99999;
      }

      #textForm {
        display: flex;
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 2.5em;
        z-index: -99999;
        opacity: 0;
      }

      #textCapture {
        flex-grow: 1;
      }

      #textSubmit {
        width: 6.66em;
      }

      #notes {
        display: inline-block;
        text-align: start;
      }

      summary {
        margin: 0.75em 0;
      }

      #addonFilesTemplate {
        display: none;
      }

      .addonFilesField {
        display: inline-block;
        width: 100%;
        margin: 0.1em 0;
      }

      .addonFilesField label,
      .addonFilesField .addonButton,
      #addonButtonAdd,
      #resetbtn {
        width: 2.5em;
        background-color: darkgray;
        background-image: linear-gradient(black, darkgray);
        color: white;
        border: 0.1em gray solid;
        display: inline-block;
        line-height: 2.5em;
        cursor: default;
        text-align: center;
      }

      #resetbtn {
        width: 160px;
        height: 48px;
        font-weight: bold;
        display: none;
      }

      .addonFilesField label,
      .addonFilesField input[type=file] {
        width: 12.5em;
        height: 2.5em;
        cursor: pointer;
      }

      .addonFilesField input[type=file] {
        font-size: 1em;
      }

      .addonFilesField .addonDelete {
        margin-left: 0.1em;
      }

      .addonFilesField input[type=file] {
        display: none;
      }

      #addonButtonAdd {
        width: 15.3em;
        margin: 0.1em 0;
      }
    </style>
  </head>
  <body>
    <div id="content">
      <div id="status-cont" class="emscripten">
        <div id="header">
          <p>
            <img id="logo" src="assets/srb2logo.png"/>
          </p>
        </div>
        <div id="details">
          <p>
            <button id="startbtn" onclick="startload()">Play</button>
            <span hidden class="emscripten" id="status"></span>
          </p>
          <progress value="0" max="100" id="progress" hidden=1></progress>
          <p>
            <button id="resetbtn" onclick="javascript:window.location.reload()">Cancel</button>
          </p>
        </div>
        <form id="controlsForm" action="javascript:void(0);">
          <details id="addons">
            <summary>Mods</summary>
            <div id="addonFilesContainer">
              <div class="addonFilesField" id="addonFilesTemplate">
                <input type="file" id="addonFiles"/>
                <label for="addonFiles">Load File</label><!--
                --><div class="addonButton addonDelete">-</div>
              </div>
            </div>
            <div id="addonButtonAdd">+</div>
            <details id="addonsHelp">
              <summary>Mod Help</summary>
              <p>You may load one or more mods here. Drag each mod to change its loading order.</p>
              <p>Or, you may load ZIP files. They will be available in the Addons Menu.</p>
              <p>To load savegames and gamedata, place them in a folder titled <code>.srb2/</code> within the ZIP file.</p>
              <p>Your stored gamedata will be overwritten.</p>
              <p><a href="https://mb.srb2.org/forumdisplay.php?f=116" target="_blank">You may find mods here</a>.</p>
            </details>
          </details>
          <details id="controls">
            <summary>Settings</summary>
            <p>
              <label for="resizeHeight">Resolution</label>
            <input type="range" id="resizeHeight" name="resizeHeight" oninput="showValue(this, 'p', (elem) => { return elem.value < 200; }, 'Full');"
                min="100" max="800" value="400" step="100"/>
              <span id="resizeHeightValue"></span>
            </p>
            <p>
              <input type="checkbox" id="playMusic" checked/>
              <label for="playMusic">Play Music</label>
              <input type="checkbox" id="playSound" checked/>
              <label for="playSound">Play Sounds</label>
            </p>
            <details id="advancedControls">
              <summary>Advanced</summary>
              <p>
                <input type="checkbox" id="skipIntro"/>
                <label for="skipIntro">Skip Intro</label>
                <input type="checkbox" id="shadow" checked/>
                <label for="shadow">Render Shadows</label>
              </p>
              <p>
                <label for="userArguments">Command Line</label><br/>
                <textarea id="systemArguments" rows="2" readonly></textarea><br/>
                <textarea id="userArguments" rows="2" placeholder="Custom Arguments"></textarea>
              </p>
            </details>
          </details>
        </form>
        <details id="footer">
          <summary>About</summary>
          <ul id="notes">
            <lh>Game Notes:</lh>
            <li>No network play</li>
            <li>Config/Save games DO work</li>
            <li>Controllers DO work</li>
            <li>If this page crashes, try refreshing this page or restarting your browser.</li>
          </ul>
          <p>Sonic Robo Blast 2 is a 3D Sonic the Hedgehog fangame inspired by the original Sonic games of the 1990s.</p>
          <p>This project allows you to play SRB2 on your web browser, including iPhone and iPad.</p>
          <p><a href="https://git.magicalgirl.moe/digiku/SRB2/issues/2">View issues</a> / <a href="https://github.com/Jimita/SRB2/compare/android-port-dynres...mazmazz:emscripten-touch">View source</a></p>
          <p>Contributors:</p>
          <p><a href="https://github.com/mazmazz">mazmazz</a> / <a href="https://github.com/heyjoeway">heyjoeway</a> / <a href="https://github.com/Jimita">Jimita</a></p>
          <p>Follow SRB2:</p>
          <p><a href="https://www.srb2.org">Website</a> / <a href="https://twitter.com/SonicTeamJr">Twitter</a> / <a href="https://discord.com/invite/pYDXzpX">Discord</a></p>
        </details>
      </div>
    </div>
    
    <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" tabindex="-1" style="z-index:-9999;"></canvas>

    <textarea id="keyCapture" oncontextmenu="event.preventDefault()" tabindex="-1"></textarea>

    <form id="textForm" onsubmit="InjectText();" action="javascript:void(0);" autocomplete="off">
      <input id="textCapture" tabindex="-1" placeholder="Console Command" disabled/>
      <input id="textSubmit" type="submit" value="Enter"/>
    </form>

    <script type='text/javascript'>
      ////////////////////////////////
      // UI
      ////////////////////////////////

      var canvasElement = document.getElementById('canvas');
      var statusElement = document.getElementById('status');
      var progressElement = document.getElementById('progress');
      var controlsFormElement = document.getElementById('controlsForm');
      var addonFields = 0;

      var deleteNode = (node) => {
        node.querySelectorAll('*').forEach(n => n.remove());
        node.remove();
      };

      var startload = () => {
        saveFormToStorage(controlsFormElement);
        var script = document.createElement('script');
        script.setAttribute('src','./srb2.js');
        document.head.appendChild(script);
        statusElement.hidden = false;
        document.getElementById('startbtn').hidden = true;
        document.getElementById('addons').style.display = "none";
        document.getElementById('controls').style.display = "none";
        document.getElementById('footer').style.display = "none";
        document.getElementById('resetbtn').style.display = "inline-block";
        document.body.classList.add('calledRun');
      };

      var showValue = (elem, suffix, overrideTest, override) => {
        if (typeof overrideTest !== 'undefined' && overrideTest(elem))
          document.getElementById(`${elem.id}Value`).innerText = override;
        else
          document.getElementById(`${elem.id}Value`).innerText = `${elem.value}${suffix}`;
      };

      var saveFormToStorage = (form) => {
        let inputs = form.querySelectorAll('input, textarea');
        inputs.forEach(input => {
          if (input.type !== 'file')
            localStorage.setItem(`${form.id}_${input.id}`, 
                                  input.type === 'checkbox' ? input.checked
                                  : input.value);
        });
      };

      var loadFormFromStorage = (form) => {
        let inputs = form.querySelectorAll('input, textarea');
        inputs.forEach(input => {
          let val = localStorage.getItem(`${form.id}_${input.id}`);
          if (val !== null && !input.readOnly && input.type !== 'file') {
            if (input.type === 'checkbox')
              input.checked = (val === "true");
            else
              input.value = val;
          }
        });
      };

      var handleInput = (e) => {
        if (e.target.type !== 'file') {
          localStorage.setItem(`${controlsFormElement.id}_${e.target.id}`, 
                              e.target.type === 'checkbox' ? e.target.checked
                              : e.target.value);
        }
        buildControlArguments();
        document.getElementById("systemArguments").value = systemArgumentsToString();
      };

      var addFormEventListeners = (form, event, callback, settings) => {
        let inputs = form.querySelectorAll('input, textarea');
        inputs.forEach(input => input.addEventListener(event, callback, settings));
      };

      var deleteAddonField = (elem) => {
        deleteNode(elem);
        if (!document.getElementById("addonFilesContainer").querySelectorAll('.addonFilesField:not([id=addonFilesTemplate])').length)
          addAddonField();
      };

      var handleDeleteAddon = (e) => {
        deleteAddonField(e.target.parentElement);
        buildControlArguments();
        document.getElementById("systemArguments").value = systemArgumentsToString();
      }

      var handleFileInput = (e) => {
        if (e.target.files.length) {
          let name = e.target.files[0].name;
          // truncate name ourselves, because overflow: hidden bugs the layout
          if (name.length > 16)
            name = `${name.substring(0, 16)}...`;
          e.target.parentElement.querySelector('label').innerText = name;
        }
      };

      var addAddonField = () => {
        let newField = document.getElementById("addonFilesTemplate").cloneNode(true);
        newField.id = `addonFilesField${addonFields}`;
        newField.querySelector('input[type=file]').id = `addonFiles${addonFields}`;
        newField.querySelector('input[type=file]').addEventListener('input', handleFileInput, false);
        newField.querySelector('input[type=file]').addEventListener('input', handleInput, false);
        newField.querySelector('label').htmlFor = `addonFiles${addonFields}`;
        // iOS file inputs do not emit input events, so let's expose
        // the input element itself so the user can see the filename.
        if (userAgentIsiOS()) {
          newField.querySelector('label').style.display = 'none';
          newField.querySelector('input[type=file]').classList.add('addonButton');
          newField.querySelector('input[type=file]').style.display = 'inline-block';
        }
        newField.querySelector('.addonDelete').addEventListener('click', handleDeleteAddon, false);
        newField.style.display = 'block';
        document.getElementById("addonFilesContainer").insertBefore(newField, null);
        addonFields++;
      };

      var initializeiOSLanding = () => {
        if (userAgentIsiOS()) {
          if (!isStandalone()) {
            document.getElementById("details").innerHTML = "<p style='font-weight: 900;'>To play, add this site to your Home Screen!</p>";
            document.getElementById("addons").style.display = "none";
            document.getElementById("controls").style.display = "none";
            document.getElementById("notes").style.display = "none";
            return true;
          }
        }
      };

      var initializeFormFields = () => {
        loadFormFromStorage(controlsFormElement);

        // By default, mobile phones should run at 200p.
        if (localStorage.getItem('controlsForm_resizeHeight') === null && userAgentIsMobile())
            document.getElementById('resizeHeight').value = 200;
        
        showValue(document.getElementById('resizeHeight'), 'p', (elem) => { return elem.value < 200; }, 'Full');

        addFormEventListeners(controlsFormElement, 'input', handleInput, false);

        buildControlArguments();
        document.getElementById("systemArguments").value = systemArgumentsToString();
      };

      var initializeAddons = () => {
        addAddonField();
        document.getElementById("addonButtonAdd").addEventListener('click', addAddonField, false);
        Sortable.create(document.getElementById('addonFilesContainer'), {
          onEnd: () => {
            buildControlArguments();
            document.getElementById("systemArguments").value = systemArgumentsToString();
          }
        });
      };

      var initializeSections = () => {
        document.getElementById('addons').open = (localStorage.getItem('addons') === 'true');
        document.getElementById('addonsHelp').open = (localStorage.getItem('addonsHelp') === 'true'
          || localStorage.getItem('addonsHelp') === null);
        document.getElementById('controls').open = (localStorage.getItem('controls') === 'true');
        document.getElementById('advancedControls').open = (localStorage.getItem('advancedControls') === 'true');

        document.getElementById('addons').addEventListener('toggle', function(e) {
          localStorage.setItem('addons', event.target.open);
        }, false);

        document.getElementById('addonsHelp').addEventListener('toggle', function(e) {
          localStorage.setItem('addonsHelp', event.target.open);
        }, false);

        document.getElementById('controls').addEventListener('toggle', function(e) {
          localStorage.setItem('controls', event.target.open);
        }, false);

        document.getElementById('advancedControls').addEventListener('toggle', function(e) {
          localStorage.setItem('advancedControls', event.target.open);
        }, false);
      };

      window.addEventListener('load', function() {
        if (!initializeiOSLanding()) {
          initializeAddons();
          initializeFormFields();
          initializeSections();
        }
      }, {once: true});

      ////////////////////////////////
      // Utilities
      ////////////////////////////////
      
      var userAgentIsiOS = () => {
        var ua = window.navigator.userAgent;
        var iOS = !!ua.match(/iPad/i) || !!ua.match(/iPhone/i) || !!ua.match(/iPod/i);
        var webkit = !!ua.match(/WebKit/i);
        var iOSSafari = iOS && webkit && !ua.match(/CriOS/i);
        return iOSSafari;
      };

      var userAgentIsiPhone = () => /iPhone|iPod/.test(navigator.userAgent);

      var isStandalone = () => (
        ("standalone" in window.navigator) &&
        window.navigator.standalone
      );

      // https://stackoverflow.com/a/11381730
      var userAgentIsMobile = () => {
        let check = false;
        (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
        return check;
      };

      var userAgentIsAndroid = () => /Android/.test(navigator.userAgent);

      var resizeDimensions = (x, y, resizeHeight) => {
        let portrait = (x < y);
        let width = Math.max(x, y);
        let height = Math.min(x, y);
        let target = Math.max(resizeHeight, (portrait ? 320 : 200)); // BASEVIDHEIGHT
        let factor;

        if (!resizeHeight)
          return {x:x, y:y};
        
        factor = target / height;
        if (width * factor < 320) // BASEVIDWIDTH
          factor = 320 / width;

        width *= factor;
        height *= factor;

        if (portrait)
        {
          x = Math.ceil(height);
          y = Math.ceil(width);
        }
        else
        {
          x = Math.ceil(width);
          y = Math.ceil(height);
        }
        return {x:x, y:y};
      };

      var fn = (path) => path.split('\\').pop().split('/').pop();
      var base = (path) => {
        let arr = path.split('\\').pop().split('/');
        arr.pop();
        return arr.join('/');
      };

      // iOS Safari does not implement Blob.arrayBuffer(), so let's
      // do it ourselves.
      // https://gist.github.com/hanayashiki/8dac237671343e7f0b15de617b0051bd
      function myArrayBuffer () {
        // this: File or Blob
        return new Promise((resolve) => {
          let fr = new FileReader();
          fr.onload = () => {
            resolve(fr.result);
          };
          fr.readAsArrayBuffer(this);
        })
      }

      var implementArrayBuffer = () => {
        if ('File' in self)
          File.prototype.arrayBuffer = File.prototype.arrayBuffer || myArrayBuffer;
        if ('Blob' in self)
          Blob.prototype.arrayBuffer = Blob.prototype.arrayBuffer || myArrayBuffer;
      };

      implementArrayBuffer();

      var initializeFS = () => {
        FS.mkdirTree('/addons');
        FS.symlink('/home/web_user/.srb2', '/addons/.srb2');
        FS.mount(IDBFS, {}, '/home/web_user');
        return (new Promise((resolve, reject) => {
          FS.syncfs(true, (err) => {
            console.log("syncFS done");
            console.log(err);
            resolve();
          });
        }));
      };

      var writeFS = (basePath, path, data) => {
        if (data instanceof ArrayBuffer)
          data = new Uint8Array(data);
        // split path to base dir and filename
        if (path.includes('/') || path.includes('\\'))
          basePath = `${basePath}/${base(path)}`;
        path = fn(path);
        // check for symlinks
        let parents = '/';
        basePath.split('/').forEach((name) => {
          if (name.length) {
            let mode = 0;
            try { mode = FS.lstat(`${parents}${name}`)['mode']; } catch(err) { console.log('writeFS(): lstat info'); console.log(err); }
            if (FS.isLink(mode))
              parents = `${FS.readlink(`${parents}${name}`)}/`;
            else
              parents += `${name}/`;
          }
        });
        basePath = parents.substring(0, parents.length-1);
        console.log(`writeFS(): Writing ${basePath}/${path}: ${data.byteLength} bytes`);
        // attempt write
        try { FS.mkdirTree(parents); } catch(err) { console.log('writeFS(): mkdirTree info'); console.log(err); }
        try { FS.unlink(`${basePath}/${path}`); } catch(err) { console.log('writeFS(): unlink info'); console.log(err); }
        FS.createDataFile(basePath, path, data, true, true);
        return Promise.resolve();
      };

      var syncFS = () => {
        // commit to persistent storage
        return (new Promise((resolve, reject) => {
          FS.syncfs((err) => {
            console.log('Synced persistent storage');
            console.log(err);
            resolve(err);
          });
        }));
      };

      var lazyLoadFileToFS = (url, baseDest) => {
        let dependencyId = `download-${fn(url)}`;
        let basePath = (baseDest === undefined ? '/home/web_user/.srb2' : baseDest);
        let name = `${fn(url)}`;
        addRunDependency(dependencyId);
        console.log(`Checking ${name}...`);

        return fetch(url, {
          method: 'HEAD'
        })
        .then((response) => {
          let remote_size = parseInt(response.headers.get('Content-Length'));

          try {
            let local_size = parseInt(FS.stat(`${basePath}/${name}`)['size']);
            if (remote_size == local_size)
              return resolve(`${name} already loaded`);
            FS.unlink(`${basePath}/${name}`);
            console.log(`Downloading ${fn(url)}...`);
          } catch(e) { /* File doesn't exist */ }

          return fetch(url);
        })
        .then((response) => response.arrayBuffer())
        .then((buffer) => {
          data = new Uint8Array(buffer);
          FS.createDataFile(basePath, name, data, true, true);
          return syncFS;
        })
        .catch((reason) => console.error(reason))
        .finally(() => removeRunDependency(dependencyId));
      };

      var downloadFS = () => {
        if (Module['calledRun'])
          pauseLoop();
        
        initializeFS()
        .then(() => {
          // TODO
        })
        .catch((err) => console.log(err));
        
        if (Module['calledRun'])
          resumeLoop();
      };

      var extractZipFile = (basePath, buffer) => {
        return JSZip.loadAsync(buffer)
        .then((zip) => {
          let files = [];
          zip.forEach((path, file) => {
            if (!file['dir']) {
              files.push(
                zip.file(path).async('uint8array')
                .then((data) => {
                  return writeFS(basePath, path, data);
                })
              );
            } else {
              try { FS.mkdir(`${basePath}/${path}`); } catch(e) { }
            }
          });
          return Promise.all(files)
          .then(syncFS)
          .catch((err) => console.log(err));
        });
      };

      var downloadExtractZipFile = (url, baseDest, cors) => {
        let preUrl = cors ? 'https://cors-anywhere.herokuapp.com/' : '';
        return fetch(`${preUrl}${url}`, cors ? {mode: 'cors'} : {})
          .then((response) => response.blob())
          .then((buffer) => extractZipFile(baseDest, buffer))
          .catch((err) => console.log(err));
      };

      var downloadDataFile = (url, baseDest, path, cors) => {
        let preUrl = cors ? 'https://cors-anywhere.herokuapp.com/' : '';
        return fetch(`${preUrl}${url}`, cors ? {mode: 'cors'} : {})
          .then((response) => response.arrayBuffer())
          .then((buffer) => writeFS(baseDest, path, new Uint8Array(buffer)))
          .catch((err) => {
            console.log(err);
          });
      };

      var loadAddons = () => {
        let addons = [];
        let inputs = document.getElementById("addonFilesContainer").querySelectorAll(".addonFilesField:not([id=addonFilesTemplate]) input[type=file]");
        inputs.forEach((input) => {
          if (input.files.length) {
            if (input.files[0].name.endsWith('.zip'))
              addons.push(extractZipFile('/addons', input.files[0]));
            else{
              addons.push(input.files[0].arrayBuffer()
              .then((buffer) => writeFS('/addons', input.files[0].name.replace(' ', '_'), new Uint8Array(buffer)))
              .catch((err) => { console.log('loadAddons():'); console.log(err); })
              );}
          }
        });
        return Promise.all(addons)
        .catch(err => { console.log('loadAddons() error'); console.log(err); });
      };

      ////////////////////////////////
      // Emscripten Module -- Runtime Parameters
      ////////////////////////////////

      var systemArguments = [
        '+addons_option','CUSTOM',
        '+addons_folder','/addons',
        '-file','/emscripten.pk3'
      ];

      var controlArguments = [];

      var userArguments = [];

      var buildControlArguments = () => {
        let inputs = controlsFormElement.querySelectorAll('input, textarea');
        let files = document.getElementById('addonFilesContainer').querySelectorAll('input[type=file]')
        let args = [];

        // do files first, so we can use the '-file' operator from systemArguments
        files.forEach(input => {
          if (input.files.length && !input.files[0].name.endsWith('.zip'))
            args.push(`/addons/${input.files[0].name.replace(' ', '_')}`);
        });

        inputs.forEach(input => {
          switch(input.id) {
            case 'resizeHeight': {
              let resizeHeight = input.value < 200 ? 0 : input.value;
              let dims = resizeDimensions(
                document.documentElement.clientWidth,
                document.documentElement.clientHeight,
                resizeHeight
              );
              args.push(
                '+scr_resizeheight', resizeHeight.toString(),
                '-width', dims.x.toString(),
                '-height', dims.y.toString()
              );
              break;
            }
            case 'playMusic': {
              let val = (input.checked ? 'on' : 'off');
              args.push(
                '+midimusic',val,
                '+digimusic',val
              );
              break;
            }
            case 'playSounds': {
              let val = (input.checked ? 'on' : 'off');
              args.push(
                '+sounds',val
              );
              break;
            }
            case 'skipIntro':
              if(input.checked)
                args.push('-skipintro');
              break;
            case 'shadow': {
              let val = (input.checked ? 'on' : 'off');
              args.push(
                '+shadow',val
              );
              break;
            }
          }
        });
        // Don't trust iPhone to give reliable resize events. Handle ourselves.
        if (userAgentIsiPhone())
          args.push('+scr_resize', 'off');
        else
          args.push('+scr_resize', 'on');
        controlArguments = args;
      };

      var buildUserArguments = () => {
        let argString = document.getElementById('userArguments').value;
        let args = [];
        if (argString.trim().length > 0)
          args = argString.split(' ');
        userArguments = args;
      };

      var systemArgumentsToString = () => `${systemArguments.join(' ')} ${controlArguments.join(' ')}`;

      ////////////////////////////////
      // Emscripten Module -- Runtime Parameters
      ////////////////////////////////

      var StartedMainLoopCallback = () => {
        document.getElementById('canvas').style.zIndex = "9999";
        document.body.classList.add('startedMainLoop');
        // go scorched earth to save memory
        deleteNode(document.getElementById('content'));
      };

      var Module = {
        arguments: [],

        calledRun: false,

        preRun: [() => {
          buildControlArguments();
          buildUserArguments();
          Module['arguments'].push(...systemArguments, ...controlArguments, ...userArguments);

          ////////////////////////////////
          // Mount filesystem, then check for music.dta
          ////////////////////////////////

          addRunDependency('mount-filesystem');
          initializeFS()
          .then(()=>{
            if (!userAgentIsiOS())
              return lazyLoadFileToFS('assets/music.dta');
            else
              Promise.resolve();
          })
          .then(loadAddons)
          .finally(() => removeRunDependency('mount-filesystem'));
        }],

        onExit: () => {
          window.location.reload();
        },
        
        ////////////////////////////////
        // Platform Stuff
        ////////////////////////////////

        print: (function() {
          var element = document.getElementById('output');
          if (element) element.value = ''; // clear browser cache
          return function(text) {
            if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
            if (element) {
              element.value += text + "\n";
              element.scrollTop = element.scrollHeight; // focus on bottom
            }
          };
        })(),
        printErr: function(text) {
          if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
          console.error(text);
        },
        canvas: (function() {
          var canvas = document.getElementById('canvas');

          // As a default initial behavior, pop up an alert when webgl context is lost. To make your
          // application robust, you may want to override this behavior before shipping!
          // See http://www.khronos.org/registry/webgl/specs/latest/1.0/#5.15.2
          canvas.addEventListener("webglcontextlost", function(e) { alert('WebGL context lost. You will need to reload the page.'); e.preventDefault(); }, false);

          return canvas;
        })(),
        setStatus: function(text) {
          if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
          if (text === Module.setStatus.last.text) return;
          var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
          var now = Date.now();
          if (m && now - Module.setStatus.last.time < 30) return; // if this is a progress update, skip it if too soon
          Module.setStatus.last.time = now;
          Module.setStatus.last.text = text;
          if (m) {
            text = m[1];
            progressElement.value = parseInt(m[2])*100;
            progressElement.max = parseInt(m[4])*100;
            progressElement.hidden = false;
          } else {
            text = "Starting game... (may take a minute)";
          }
          statusElement.innerHTML = text;
        },
        totalDependencies: 0,
        monitorRunDependencies: function(left) {
          this.totalDependencies = Math.max(this.totalDependencies, left);
          Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
        }
      };
      Module.setStatus('Downloading...');
      window.onerror = function(event) {
        // TODO: do not warn on ok events like simulating an infinite loop or exitStatus
        // Module.setStatus('Exception thrown, see JavaScript console');
        Module.setStatus = function(text) {
          if (text) Module.printErr('[post-exception status] ' + text);
        };
      };

      ////////////////////////////////
      // iOS Support
      ////////////////////////////////

      // iOS Safari requires us to activate WebAudio context upon user touch.
      // The runtime will use this same audioContext.
      // https://paulbakaus.com/tutorials/html5/web-audio-on-ios/
      var activateAudio = function() {
        if (typeof (Module['SDL2']) === 'undefined') {
            Module['SDL2'] = {};
        }
        var SDL2 = Module['SDL2'];
        if (typeof(Module['SDL2'].audioContext) !== 'undefined' 
            || !Module['SDL2'].audioContext) {
            if (typeof (AudioContext) !== 'undefined') {
                SDL2.audioContext = new AudioContext();
            } else if (typeof (webkitAudioContext) !== 'undefined') {
                SDL2.audioContext = new webkitAudioContext();
            }
        }
        if (typeof(Module['SDL2'].audioContext) !== 'undefined' 
            && SDL2.audioContext.currentTime == 0) {
          var buffer = SDL2.audioContext.createBuffer(1, 1, 44100);
          var source = SDL2.audioContext.createBufferSource();
          source.buffer = buffer;
          source.connect(SDL2.audioContext.destination);
          source.start();
        }

        if (Module['calledRun'])
          Module.ccall('COM_ImmedExecute',
            null,
            ['string'],
            ['restartaudio']
          );
      };

      var handleViewportChange = () => {
        changeResolution();
      };

      window.addEventListener('load', function() {
        if(userAgentIsiOS()) {
          if(isStandalone()) {
            window.addEventListener('touchend', activateAudio, {once: true});
            window.addEventListener('resize', handleViewportChange, false);
          }
        }
      }, {once: true});

      ////////////////////////////////
      // Pause/Resume
      ////////////////////////////////

      var pauseLoop = () => {
        if (Module['calledRun'])
          Module.ccall('pause_loop',
            'number',
            [],
            []
          );
      };

      var resumeLoop = () => {
        if (Module['calledRun'])
          Module.ccall('resume_loop',
            'number',
            [],
            []
          );
      };

      var doResume = () => {
        if (Module['calledRun']) {
          let SDL2 = null;
          if (typeof (Module['SDL2']) !== 'undefined')
            SDL2 = Module['SDL2'];

          if (typeof(SDL2.audioContext) === 'undefined'
              || !SDL2.audioContext 
              || SDL2.audioContext.status === 'closed') {
            SDL2.audioContext = null;
            if (userAgentIsiOS())
              window.addEventListener('touchend', activateAudio, {once: true});
            else
              activateAudio();
          } else
            SDL2.audioContext.resume();
          resumeLoop();
          changeResolution();
        }
        window.removeEventListener('touchend', doResume, {once: true});
        window.removeEventListener('click', doResume, {once: true});
        window.removeEventListener('keydown', doResume, {once: true});
      };

      var handleVisibilityChange = (e) => {
        if (Module['calledRun']) {
          let SDL2 = null;
          if (typeof (Module['SDL2']) !== 'undefined')
            SDL2 = Module['SDL2'];

          if (e.type === 'focus')
            doResume();
          else {
            pauseLoop();
            if (typeof(SDL2.audioContext) !== 'undefined'
                && SDL2.audioContext)
              SDL2.audioContext.suspend();
            // just in case the browser does not fire a 'focus'
            // event upon our return, allow the user to touch to wake
            window.addEventListener('touchend', doResume, {once: true});
            window.addEventListener('click', doResume, {once: true});
            window.addEventListener('keydown', doResume, {once: true});
          }
        }
      };

      window.addEventListener('load', function() {
        // on iOS 12, only blur/focus fire on change to home or power button
        window.addEventListener('blur', handleVisibilityChange);
        window.addEventListener('focus', handleVisibilityChange);
      }, {once: true});

      ////////////////////////////////
      // On-Screen Keyboard
      ////////////////////////////////

      var keyCaptureElement = document.getElementById("keyCapture");
      var textCaptureElement = document.getElementById("textCapture");
      var activeCaptureElement = null;
      var closeDelay = 0;

      var I_RaiseScreenKeyboard = () => {
        closeDelay = 0;
        // iOS users need to touch the keyCapture element to show the
        // keyboard, so don't close it on the next touch.
        if (userAgentIsiOS())
          closeDelay++;
        if (userAgentIsAndroid()) {
          activeCaptureElement = textCaptureElement;
          textCaptureElement.parentElement.style.zIndex = '100000';
          textCaptureElement.parentElement.style.opacity = '1.0';
          textCaptureElement.disabled = false;
        } else
          activeCaptureElement = keyCaptureElement;
        keyCaptureElement.value = ".";
        keyCaptureElement.style.zIndex = '99999';
        keyCaptureElement.addEventListener('touchend', HandleTouchKeyboard, false);
        activeCaptureElement.focus();
      };

      var I_KeyboardOnScreen = () => {
        return document.activeElement === activeCaptureElement;
      };

      var I_CloseScreenKeyboard = () => {
        activeCaptureElement.blur();
        keyCaptureElement.style.zIndex = '-99999';
        textCaptureElement.parentElement.style.zIndex = '-99999';
        textCaptureElement.parentElement.style.opacity = '0.0';
        textCaptureElement.disabled = true;
        keyCaptureElement.removeEventListener('touchend', HandleTouchKeyboard, false);
        if (activeCaptureElement === textCaptureElement) {
          textCaptureElement.removeEventListener('keydown', CaptureKeyEvent, true);
          textCaptureElement.removeEventListener('keyup', CaptureKeyEvent, true);
        }
      };

      var HandleTouchKeyboard = () => {
        if (closeDelay-- <= 0)
          I_CloseScreenKeyboard();
      };

      var InjectText = () => {
        let text = activeCaptureElement.value;
        activeCaptureElement.focus();
        if (Module['calledRun'] && text) {
          Module.ccall('inject_text',
            null,
            ['string'],
            [text]
          );
          // ENTER keydown
          Module.ccall('inject_keycode',
            null,
            ['int','int'],
            [13,false]
          );
          // ENTER keyup 
          Module.ccall('inject_keycode',
            null,
            ['int','int'],
            [13,true]
          );
        }
        activeCaptureElement.value = '';
      };

      ////////////////////////////////
      // Viewport Changes
      ////////////////////////////////

      var changeResolution = (x, y) => {
        if (Module['calledRun']) {
          if (typeof x === 'undefined')
            x = document.documentElement.clientWidth;
          if (typeof y === 'undefined')
            y = document.documentElement.clientHeight;
          Module.ccall('change_resolution',
            'number',
            ['number', 'number'],
            [x, y]
          );
        }
      };

      var AllowWindowResize = () => {
        return (!I_KeyboardOnScreen() || !userAgentIsMobile() || 
          // If OSK and mobile, be careful about resizing.
          // We generally want to allow it. Portrait is safe because OSK's are not tall.
          //
          // However, landscape is dangerous because the keyboard may take most of the
          // screen, resulting in a viewport ratio that's way too wide,
          // resulting in a big window size that can crash the game. So do a sanity check.
          document.documentElement.clientHeight > document.documentElement.clientWidth ||
          document.documentElement.clientWidth / document.documentElement.clientHeight <= 2.167);
      };
    </script>
    <!-- {{{ SCRIPT }}} -->
  </body>
</html>
