<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
    <link rel="apple-touch-icon" href="assets/srb2.png">
    <meta name="apple-mobile-web-app-title" content="SRB2">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-2048-2732.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-2732-2048.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-1668-2388.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-2388-1668.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-1668-2224.png" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-2224-1668.png" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-1536-2048.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-2048-1536.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-1242-2688.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-2688-1242.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-1125-2436.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-2436-1125.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-828-1792.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-1792-828.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-1242-2208.png" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-2208-1242.png" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-750-1334.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-1334-750.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-640-1136.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-1136-640.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <title>Sonic Robo Blast 2</title>
    <style>
      body {
        font-family: arial;
        margin: 0;
        padding: none;
        background: #000;
        color: #fff;
      }

      #status-cont {
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        font-weight: bold;
        text-align: center;
      }

      #progress {
        height: 20px;
        width: 256px;
      }

      #canvas {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
      }

      #logo {
        display: inline-block;
        width: 192px;
        height: 192px;
        background-image: url("assets/srb2.png");
        background-size: 100% 100%;
      }
    </style>
  </head>
  <body>   
    <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" tabindex=-1></canvas>

    <div id="status-cont" class="emscripten">
      <div id="logo"></div>
      <div style="text-align: center;">
          <h1><a href="https://www.srb2.org" target="_blank">SRB2</a> v2.2.4</h1>
          <div id="details">
            <p>
              <button id="startbtn">Start Game</button>
              <span hidden class="emscripten" id="status"></span>
            </p>
            <progress value="0" max="100" id="progress" hidden=1></progress>
            <div style="text-align: left;">
              <p>Notes:</p>
              <ul>
                  <li>No online</li>
                  <li>Config/Save games DO work</li>
                  <li>Controllers DO work</li>
              </ul>
            </div>
          </div>
          <p>Contributors: <a href="https://github.com/mazmazz">mazmazz</a>, <a href="https://github.com/heyjoeway">heyjoeway</a>, <a href="https://github.com/Jimita">Jimita</a>. <a href="https://github.com/Jimita/SRB2/compare/android-port...mazmazz:emscripten-touch">View the source</a>.</p>
      </div>
    </div>

    <script type='text/javascript'>
      var statusElement = document.getElementById('status');
      var progressElement = document.getElementById('progress');

      var startload = function () {
        var script = document.createElement('script');
        script.setAttribute('src','./srb2.js');
        document.head.appendChild(script);
        statusElement.hidden = false;
        document.getElementById('startbtn').hidden = true;
        document.getElementById('status-cont').style.zIndex = "-9999";
      }

      ////////////////////////////////
      // Utilities
      ////////////////////////////////
      
      var userAgentIsiOS = () => {
        var ua = window.navigator.userAgent;
        var iOS = !!ua.match(/iPad/i) || !!ua.match(/iPhone/i) || !!ua.match(/iPod/i);
        var webkit = !!ua.match(/WebKit/i);
        var iOSSafari = iOS && webkit && !ua.match(/CriOS/i);
        return iOSSafari;
      };

      var userAgentIsiPhone = () => /iPhone|iPod/.test(navigator.userAgent);

      var isStandalone = () => (
        ("standalone" in window.navigator) &&
        window.navigator.standalone
      );

      var fn = (path) => path.split('\\').pop().split('/').pop();

      var lazyLoadFileToFS = (url, baseDest) => {
        let dependencyId = `download-${fn(url)}`;
        let basePath = (baseDest === undefined ? '/home/web_user/.srb2' : baseDest);
        let name = `${fn(url)}`;
        addRunDependency(dependencyId);
        console.log(`Checking ${name}...`);

        return fetch(url, {
          method: 'HEAD'
        })
        .then((response) => {
          let remote_size = parseInt(response.headers.get('Content-Length'));

          try {
            let local_size = parseInt(FS.stat(`${basePath}/${name}`)['size']);
            if (remote_size == local_size)
              return resolve(`${name} already loaded`);
            FS.unlink(`${basePath}/${name}`);
            console.log(`Downloading ${fn(url)}...`);
          } catch(e) { /* File doesn't exist */ }

          return fetch(url);
        })
        .then((response) => {
          return response.arrayBuffer();
        })
        .then((buffer) => {
          data = new Uint8Array(buffer);
          FS.createDataFile(basePath, name, data, true, true);

          // commit to persistent storage
          return (new Promise((resolve, reject) => {
            FS.syncfs((err) => {
              console.log('Synced persistent storage');
              console.log(err);
              resolve(err);
            });
          }));
        })
        .catch((reason) => {
          console.error(reason);
        })
        .finally(() => {
          removeRunDependency(dependencyId);
        });
      };

      ////////////////////////////////
      // Emscripten Module -- Runtime Parameters
      ////////////////////////////////

      var Module = {
        arguments: [
          '-file','/emscripten.pk3',
          '+scr_resizeheight','400',
          '+addons_option','CUSTOM',
          '+addons_folder','/addons',
        ],

        preRun: [() => {
          ////////////////////////////////
          // if iPhone, then force off window resize events because
          // the reported dimensions are not reliable.
          ////////////////////////////////
          if (userAgentIsiPhone())
            Module['arguments'].push('+scr_resize','Off','-width','640','-height','400');

          ////////////////////////////////
          // Mount filesystem, then check for music.dta
          ////////////////////////////////

          addRunDependency('mount-filesystem');
          FS.mkdirTree('/addons');
          FS.symlink('/home/web_user/.srb2', '/addons/.srb2');
          FS.mount(IDBFS, {}, '/home/web_user');
          (new Promise((resolve, reject) => {
            FS.syncfs(true, (err) => {
              console.log("Intial syncFS done");
              console.log(err);
              resolve();
            });
          }))
          .then(()=>{
            if (!userAgentIsiOS())
              return lazyLoadFileToFS('assets/music.dta');
            else
              resolve();
          })
          .finally(() => {
            removeRunDependency('mount-filesystem');
          });
        }],

        postRun: [() => {
          document.getElementById('status-cont').style.zIndex = '0';
          statusElement.hidden = true;
          document.getElementById('startbtn').hidden = false;
          document.getElementById('status').innerText = '';
        }],
        
        ////////////////////////////////
        // Platform Stuff
        ////////////////////////////////

        print: (function() {
          var element = document.getElementById('output');
          if (element) element.value = ''; // clear browser cache
          return function(text) {
            if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
            if (element) {
              element.value += text + "\n";
              element.scrollTop = element.scrollHeight; // focus on bottom
            }
          };
        })(),
        printErr: function(text) {
          if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
          console.error(text);
        },
        canvas: (function() {
          var canvas = document.getElementById('canvas');

          // As a default initial behavior, pop up an alert when webgl context is lost. To make your
          // application robust, you may want to override this behavior before shipping!
          // See http://www.khronos.org/registry/webgl/specs/latest/1.0/#5.15.2
          canvas.addEventListener("webglcontextlost", function(e) { alert('WebGL context lost. You will need to reload the page.'); e.preventDefault(); }, false);

          return canvas;
        })(),
        setStatus: function(text) {
          if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
          if (text === Module.setStatus.last.text) return;
          var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
          var now = Date.now();
          if (m && now - Module.setStatus.last.time < 30) return; // if this is a progress update, skip it if too soon
          Module.setStatus.last.time = now;
          Module.setStatus.last.text = text;
          if (m) {
            text = m[1];
            progressElement.value = parseInt(m[2])*100;
            progressElement.max = parseInt(m[4])*100;
            progressElement.hidden = false;
          } else {
            text = "Starting game... (may take a minute)";
          }
          statusElement.innerHTML = text;
        },
        totalDependencies: 0,
        monitorRunDependencies: function(left) {
          this.totalDependencies = Math.max(this.totalDependencies, left);
          Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
        }
      };
      Module.setStatus('Downloading...');
      window.onerror = function(event) {
        // TODO: do not warn on ok events like simulating an infinite loop or exitStatus
        // Module.setStatus('Exception thrown, see JavaScript console');
        Module.setStatus = function(text) {
          if (text) Module.printErr('[post-exception status] ' + text);
        };
      };

      // iOS Safari requires us to activate WebAudio context upon user touch.
      // The runtime will use this same audioContext.
      // https://paulbakaus.com/tutorials/html5/web-audio-on-ios/
      var activateAudio = function() {
        if (typeof (Module['SDL2']) === 'undefined') {
            Module['SDL2'] = {};
        }
        var SDL2 = Module['SDL2'];
        if (!SDL2.audioContext) {
            if (typeof (AudioContext) !== 'undefined') {
                SDL2.audioContext = new AudioContext();
            } else if (typeof (webkitAudioContext) !== 'undefined') {
                SDL2.audioContext = new webkitAudioContext();
            }
        }
        if (SDL2.audioContext && SDL2.audioContext.currentTime == 0) {
          var buffer = SDL2.audioContext.createBuffer(1, 1, 44100);
          var source = SDL2.audioContext.createBufferSource();
          source.buffer = buffer;
          source.connect(SDL2.audioContext.destination);
          source.start();
        }
      };
      window.addEventListener('load', function() {
        if(userAgentIsiPhone() && !isStandalone()) {
          document.getElementById("details").innerHTML = "<strong>To play, add this site to your Home Screen!</strong>";
        } else {
          document.getElementById("startbtn").onclick = startload;
          document.addEventListener('touchstart', activateAudio, {once: true});
        }
      }, false);
    </script>
    <!-- {{{ SCRIPT }}} -->
  </body>
</html>
