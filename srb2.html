<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
    <link rel="apple-touch-icon" href="assets/srb2.png">
    <meta name="apple-mobile-web-app-title" content="SRB2">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-2048-2732.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-2732-2048.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-1668-2388.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-2388-1668.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-1668-2224.png" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-2224-1668.png" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-1536-2048.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-2048-1536.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-1242-2688.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-2688-1242.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-1125-2436.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-2436-1125.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-828-1792.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-1792-828.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-1242-2208.png" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-2208-1242.png" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-750-1334.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-1334-750.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-640-1136.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="assets/apple-splash-1136-640.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <title>Sonic Robo Blast 2</title>
    <style>
      html, body {
        height: 100%;
      }

      body {
        font-family: 'Segoe UI', sans-serif;
        margin: 0;
        padding: none;
        background: #000;
        color: #ffffff;
      }

      #content {
        width: 100%;
        height: 100%;
        overflow-y: auto;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #status-cont {
        font-weight: bold;
        text-align: center;
      }

      #progress {
        height: 20px;
        width: 256px;
      }

      #startbtn {
        width: 128px;
        height: 48px;
      }

      #canvas, #keyCapture {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
      }

      #keyCapture {
        opacity: 0;
        background-color: rgba(0,0,0,0);
        border: 0;
        color: rgba(0,0,0,0);
        z-index: -99999;
      }
    </style>
  </head>
  <body>   
    <div id="content">
      <div id="status-cont" class="emscripten">
        <div id="header">
          <p>
            <a href="https://www.srb2.org" target="_blank">
              <img src="assets/srb2logo.png" width="320"/>
            </a>
          </p>
        </div>
        <div id="details">
          <p>
            <button id="startbtn" onclick="startload()">Start Game</button>
            <span hidden class="emscripten" id="status"></span>
          </p>
          <progress value="0" max="100" id="progress" hidden=1></progress>
        </div>
        <div id="controls">
          <label for="resizeHeight">Resolution</label>
          <input type="range" id="resizeHeight" name="resizeHeight" oninput="showValue(this, 'p')"
            min="200" max="800" value="400" step="100"/>
          <span id="resizeHeightValue"></span>
        </div>
        <div id="notes">
          <p>Notes:</p>
          <p>No online<br/>
          Config/Save games DO work<br/>
          Controllers DO work</p>
        </div>
        <div id="footer">
          <p>Contributors: <a href="https://github.com/mazmazz">mazmazz</a>, <a href="https://github.com/heyjoeway">heyjoeway</a>, <a href="https://github.com/Jimita">Jimita</a>.</p>
          <p><a href="https://github.com/Jimita/SRB2/compare/android-port...mazmazz:emscripten-touch">View the source</a>.</p>
        </div>
      </div>
    </div>
    
    <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" tabindex="-1" style="z-index:-9999;"></canvas>

    <textarea id="keyCapture" oncontextmenu="event.preventDefault()" tabindex="-1"></textarea>

    <script type='text/javascript'>
      ////////////////////////////////
      // UI
      ////////////////////////////////

      var canvasElement = document.getElementById('canvas');
      var statusElement = document.getElementById('status');
      var progressElement = document.getElementById('progress');

      var startload = () => {
        var script = document.createElement('script');
        script.setAttribute('src','./srb2.js');
        document.head.appendChild(script);
        statusElement.hidden = false;
        document.getElementById('startbtn').hidden = true;
        document.getElementById('canvas').style.zIndex = "9999";
        document.getElementById('controls').style.display = "none";
      };

      var showValue = (elem, suffix) => {
        document.getElementById(`${elem.id}Value`).innerText = `${elem.value}${suffix}`;
      };

      var initUi = () => {
        showValue(document.getElementById('resizeHeight'), 'p');
      };

      ////////////////////////////////
      // Utilities
      ////////////////////////////////
      
      var userAgentIsiOS = () => {
        var ua = window.navigator.userAgent;
        var iOS = !!ua.match(/iPad/i) || !!ua.match(/iPhone/i) || !!ua.match(/iPod/i);
        var webkit = !!ua.match(/WebKit/i);
        var iOSSafari = iOS && webkit && !ua.match(/CriOS/i);
        return iOSSafari;
      };

      var userAgentIsiPhone = () => /iPhone|iPod/.test(navigator.userAgent);

      var isStandalone = () => (
        ("standalone" in window.navigator) &&
        window.navigator.standalone
      );

      // https://stackoverflow.com/a/11381730
      var userAgentIsMobile = () => {
        let check = false;
        (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
        return check;
      };

      var resizeDimensions = (x, y, resizeHeight) => {
        let portrait = (x < y);
        let width = Math.max(x, y);
        let height = Math.min(x, y);
        let target = Math.max(resizeHeight, (portrait ? 320 : 200)); // BASEVIDHEIGHT
        let factor;

        if (!resizeHeight)
          return {x:x, y:y};
        
        factor = target / height;
        if (width * factor < 320) // BASEVIDWIDTH
          factor = 320 / width;

        width *= factor;
        height *= factor;

        if (portrait)
        {
          x = Math.ceil(height);
          y = Math.ceil(width);
        }
        else
        {
          x = Math.ceil(width);
          y = Math.ceil(height);
        }
        return {x:x, y:y};
      };

      var fn = (path) => path.split('\\').pop().split('/').pop();

      var lazyLoadFileToFS = (url, baseDest) => {
        let dependencyId = `download-${fn(url)}`;
        let basePath = (baseDest === undefined ? '/home/web_user/.srb2' : baseDest);
        let name = `${fn(url)}`;
        addRunDependency(dependencyId);
        console.log(`Checking ${name}...`);

        return fetch(url, {
          method: 'HEAD'
        })
        .then((response) => {
          let remote_size = parseInt(response.headers.get('Content-Length'));

          try {
            let local_size = parseInt(FS.stat(`${basePath}/${name}`)['size']);
            if (remote_size == local_size)
              return resolve(`${name} already loaded`);
            FS.unlink(`${basePath}/${name}`);
            console.log(`Downloading ${fn(url)}...`);
          } catch(e) { /* File doesn't exist */ }

          return fetch(url);
        })
        .then((response) => {
          return response.arrayBuffer();
        })
        .then((buffer) => {
          data = new Uint8Array(buffer);
          FS.createDataFile(basePath, name, data, true, true);

          // commit to persistent storage
          return (new Promise((resolve, reject) => {
            FS.syncfs((err) => {
              console.log('Synced persistent storage');
              console.log(err);
              resolve(err);
            });
          }));
        })
        .catch((reason) => {
          console.error(reason);
        })
        .finally(() => {
          removeRunDependency(dependencyId);
        });
      };

      ////////////////////////////////
      // Emscripten Module -- Runtime Parameters
      ////////////////////////////////

      var Module = {
        arguments: [
          '-file','/emscripten.pk3',
          '+addons_option','CUSTOM',
          '+addons_folder','/addons',
        ],

        calledRun: false,

        preRun: [() => {
          let dims = resizeDimensions(
            document.documentElement.clientWidth,
            document.documentElement.clientHeight,
            document.getElementById('resizeHeight').value
          );
          Module['arguments'].push(
            '+scr_resizeheight', document.getElementById('resizeHeight').value.toString(),
            '-width', dims.x.toString(),
            '-height', dims.y.toString()
          );
          // Don't trust iPhone to give reliable resize events. Handle ourselves.
          if (userAgentIsiPhone())
            Module['arguments'].push('+scr_resize', 'Off');
          else
            Module['arguments'].push('+scr_resize', 'On');

          ////////////////////////////////
          // Mount filesystem, then check for music.dta
          ////////////////////////////////

          addRunDependency('mount-filesystem');
          FS.mkdirTree('/addons');
          FS.symlink('/home/web_user/.srb2', '/addons/.srb2');
          FS.mount(IDBFS, {}, '/home/web_user');
          (new Promise((resolve, reject) => {
            FS.syncfs(true, (err) => {
              console.log("Intial syncFS done");
              console.log(err);
              resolve();
            });
          }))
          .then(()=>{
            if (!userAgentIsiOS())
              return lazyLoadFileToFS('assets/music.dta');
            else
              resolve();
          })
          .finally(() => {
            removeRunDependency('mount-filesystem');
          });
        }],

        postRun: [() => {
          document.getElementById('status-cont').style.zIndex = '0';
          statusElement.hidden = true;
          document.getElementById('startbtn').hidden = false;
          document.getElementById('status').innerText = '';
        }],
        
        ////////////////////////////////
        // Platform Stuff
        ////////////////////////////////

        print: (function() {
          var element = document.getElementById('output');
          if (element) element.value = ''; // clear browser cache
          return function(text) {
            if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
            if (element) {
              element.value += text + "\n";
              element.scrollTop = element.scrollHeight; // focus on bottom
            }
          };
        })(),
        printErr: function(text) {
          if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
          console.error(text);
        },
        canvas: (function() {
          var canvas = document.getElementById('canvas');

          // As a default initial behavior, pop up an alert when webgl context is lost. To make your
          // application robust, you may want to override this behavior before shipping!
          // See http://www.khronos.org/registry/webgl/specs/latest/1.0/#5.15.2
          canvas.addEventListener("webglcontextlost", function(e) { alert('WebGL context lost. You will need to reload the page.'); e.preventDefault(); }, false);

          return canvas;
        })(),
        setStatus: function(text) {
          if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
          if (text === Module.setStatus.last.text) return;
          var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
          var now = Date.now();
          if (m && now - Module.setStatus.last.time < 30) return; // if this is a progress update, skip it if too soon
          Module.setStatus.last.time = now;
          Module.setStatus.last.text = text;
          if (m) {
            text = m[1];
            progressElement.value = parseInt(m[2])*100;
            progressElement.max = parseInt(m[4])*100;
            progressElement.hidden = false;
          } else {
            text = "Starting game... (may take a minute)";
          }
          statusElement.innerHTML = text;
        },
        totalDependencies: 0,
        monitorRunDependencies: function(left) {
          this.totalDependencies = Math.max(this.totalDependencies, left);
          Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
        }
      };
      Module.setStatus('Downloading...');
      window.onerror = function(event) {
        // TODO: do not warn on ok events like simulating an infinite loop or exitStatus
        // Module.setStatus('Exception thrown, see JavaScript console');
        Module.setStatus = function(text) {
          if (text) Module.printErr('[post-exception status] ' + text);
        };
      };

      ////////////////////////////////
      // iOS Support
      ////////////////////////////////

      // iOS Safari requires us to activate WebAudio context upon user touch.
      // The runtime will use this same audioContext.
      // https://paulbakaus.com/tutorials/html5/web-audio-on-ios/
      var activateAudio = function() {
        if (typeof (Module['SDL2']) === 'undefined') {
            Module['SDL2'] = {};
        }
        var SDL2 = Module['SDL2'];
        if (typeof(Module['SDL2'].audioContext) !== 'undefined' 
            || !Module['SDL2'].audioContext) {
            if (typeof (AudioContext) !== 'undefined') {
                SDL2.audioContext = new AudioContext();
            } else if (typeof (webkitAudioContext) !== 'undefined') {
                SDL2.audioContext = new webkitAudioContext();
            }
        }
        if (typeof(Module['SDL2'].audioContext) !== 'undefined' 
            && SDL2.audioContext.currentTime == 0) {
          var buffer = SDL2.audioContext.createBuffer(1, 1, 44100);
          var source = SDL2.audioContext.createBufferSource();
          source.buffer = buffer;
          source.connect(SDL2.audioContext.destination);
          source.start();
        }

        if (Module['calledRun'])
          Module.ccall('COM_ImmedExecute',
            null,
            ['string'],
            ['restartaudio']
          );
      };

      window.addEventListener('load', function() {
        if(userAgentIsiOS()) {
          if(!isStandalone()) {
            document.getElementById("details").innerHTML = "<strong>To play, add this site to your Home Screen!</strong>";
            document.getElementById("controls").style.display = "none";
            document.getElementById("notes").style.display = "none";
          } else {
            if (userAgentIsiPhone())
              document.getElementById("resizeHeight").value = 200;

            document.addEventListener('touchend', activateAudio, {once: true});
          }
        }
        initUi();
      }, {once: true});

      ////////////////////////////////
      // Pause/Resume
      ////////////////////////////////

      var pauseLoop = () => {
        if (Module['calledRun'])
          Module.ccall('pause_loop',
            'number',
            [],
            []
          );
      };

      var resumeLoop = () => {
        if (Module['calledRun'])
          Module.ccall('resume_loop',
            'number',
            [],
            []
          );
      };

      var doResume = () => {
        if (Module['calledRun']) {
          let SDL2 = null;
          if (typeof (Module['SDL2']) !== 'undefined')
            SDL2 = Module['SDL2'];

          if (typeof(SDL2.audioContext) === 'undefined'
              || !SDL2.audioContext 
              || SDL2.audioContext.status === 'closed') {
                SDL2.audioContext = null;
                if (userAgentIsiOS())
              window.addEventListener('touchend', activateAudio, {once: true});
                else
                  activateAudio();
              } else
                SDL2.audioContext.resume();
            resumeLoop();
            changeResolution();
        }
        window.removeEventListener('touchend', doResume, {once: true});
        window.removeEventListener('click', doResume, {once: true});
        window.removeEventListener('keydown', doResume, {once: true});
      };

      var handleVisibilityChange = (e) => {
        if (Module['calledRun']) {
          let SDL2 = null;
          if (typeof (Module['SDL2']) !== 'undefined')
            SDL2 = Module['SDL2'];

          if (e.type === 'focus')
            doResume();
          else {
            pauseLoop();
            if (typeof(SDL2.audioContext) !== 'undefined'
                && SDL2.audioContext)
              SDL2.audioContext.suspend();
            // just in case the browser does not fire a 'focus'
            // event upon our return, allow the user to touch to wake
            window.addEventListener('touchend', doResume, {once: true});
            window.addEventListener('click', doResume, {once: true});
            window.addEventListener('keydown', doResume, {once: true});
          }
        }
      };

      window.addEventListener('load', function() {
        // on iOS 12, only blur/focus fire on change to home or power button
        window.addEventListener('blur', handleVisibilityChange);
        window.addEventListener('focus', handleVisibilityChange);
      }, {once: true});

      ////////////////////////////////
      // On-Screen Keyboard
      ////////////////////////////////

      var keyCaptureElement = document.getElementById("keyCapture");
      var closeDelay = 0;

      var I_RaiseScreenKeyboard = () => {
        closeDelay = 0;
        // iOS users need to touch the keyCapture element to show the
        // keyboard, so don't close it on the next touch.
        if (userAgentIsiOS())
          closeDelay++;
        keyCaptureElement.value = ".";
        keyCaptureElement.style.zIndex = '99999';
        keyCaptureElement.addEventListener('keyup', HandleKey, false);
        keyCaptureElement.addEventListener('touchend', HandleTouchKeyboard, false);
        keyCaptureElement.focus();
      };

      var I_KeyboardOnScreen = () => {
        return document.activeElement === keyCaptureElement;
      };

      var I_CloseScreenKeyboard = () => {
        keyCaptureElement.blur();
        keyCaptureElement.style.zIndex = '-99999';
        keyCaptureElement.removeEventListener('keyup', HandleKey, false);
        keyCaptureElement.removeEventListener('touchend', HandleTouchKeyboard, false);
      };

      var HandleTouchKeyboard = () => {
        if (closeDelay-- <= 0)
          I_CloseScreenKeyboard();
      };

      var HandleKey = (e) => {
        // If user is on Android, the key codes are most likely screwy.
        // We presume the OSK is inputting text onto the textarea,
        // so infer from the text.
        //
        // This is rudimentary, and does not account for IMEs inputting
        // auto-complete. Really, users should just play the Android
        // port.
        let keyCode = e.keyCode;
        if (!keyCode || keyCode == 229) {
          if (keyCaptureElement.value.length > 1)
            keyCode = keyCaptureElement.value.charCodeAt(keyCaptureElement.value.length-1);
          else if (!keyCaptureElement.value.length) // Backspace
            keyCode = 8;
          else if (e.ctrlKey)
            keyCode = 17;
          else if (e.altKey)
            keyCode = 18;
          else if (e.shiftKey)
            keyCode = 16;
          // Missing: Arrow keys, Escape, Pause/Break, ...
          if(keyCode == 192) { //&& (e.key === '`' || e.key === '~')) {
            // SRB2 checks ` against its ASCII code (see "TILDE")
            keyCode = 96;
          }
          if (keyCode && keyCode != 229)
          {
            // keydown event
            Module.ccall('inject_keycode',
              'number',
              ['number', 'number'],
              [keyCode, 0]
            );
            // keyup event
            Module.ccall('inject_keycode',
              'number',
              ['number', 'number'],
              [keyCode, 1]
            );
          }
        }
        keyCaptureElement.value = '.';
      };

      ////////////////////////////////
      // Viewport Changes
      ////////////////////////////////

      var changeResolution = (x, y) => {
        if (Module['calledRun']) {
          if (x === undefined)
            x = document.documentElement.clientWidth;
          if (y === undefined)
            y = document.documentElement.clientHeight;
          Module.ccall('change_resolution',
            'number',
            ['number', 'number'],
            [x, y]
          );
        }
      };

      var AllowWindowResize = () => {
        return (!I_KeyboardOnScreen() || !userAgentIsMobile() || 
          // If OSK and mobile, be careful about resizing.
          // We generally want to allow it. Portrait is safe because OSK's are not tall.
          //
          // However, landscape is dangerous because the keyboard may take most of the
          // screen, resulting in a viewport ratio that's way too wide,
          // resulting in a big window size that can crash the game. So do a sanity check.
          document.documentElement.clientHeight > document.documentElement.clientWidth ||
          document.documentElement.clientWidth / document.documentElement.clientHeight <= 2.167);
      };
    </script>
    <!-- {{{ SCRIPT }}} -->
  </body>
</html>
